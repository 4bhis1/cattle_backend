#!/usr/bin/env node

import inquirer from 'inquirer';
import fs from 'fs';
import path from 'path';
import { execSync } from 'child_process';

const runSetup = async () => {
    console.log('üöÄ Welcome to the Node.js Backend Boilerplate Setup! üöÄ');
    console.log('This script will configure your project.\\n');

    const questions = [
        {
            type: 'input',
            name: 'projectName',
            message: 'What is your project name?',
            default: 'my-awesome-backend',
        },
        {
            type: 'checkbox',
            name: 'features',
            message: 'Which features do you want to enable?',
            choices: [
                { name: 'Authentication (Passport, JWT)', value: 'auth', checked: true },
                { name: 'Google Login', value: 'googleAuth', checked: false },
                { name: 'GitHub Login', value: 'githubAuth', checked: false },
                { name: 'Logging (Winston)', value: 'logging', checked: true },
                { name: 'File Uploads', value: 'upload', checked: true },
                { name: 'Email Service', value: 'email', checked: false },
            ],
        },
        // Add more questions for secrets if needed, but keeping it simple for now
        {
            type: 'confirm',
            name: 'installDeps',
            message: 'Do you want to run npm install now?',
            default: true
        }
    ];

    try {
        const answers = await inquirer.prompt(questions);

        // 1. Update package.json
        const packageJsonPath = path.join(process.cwd(), 'package.json');
        const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf-8'));
        packageJson.name = answers.projectName;
        packageJson.version = '1.0.0';
        packageJson.description = 'Generated by Pookie Coder Boilerplate';

        // Remove setup script from scripts if desired
        // delete packageJson.scripts.setup; 

        fs.writeFileSync(packageJsonPath, JSON.stringify(packageJson, null, 2));
        console.log('‚úÖ Updated package.json');

        // 2. Generate features.json
        const featuresConfig = {
            auth: {
                enabled: answers.features.includes('auth'),
                google: answers.features.includes('googleAuth'),
                github: answers.features.includes('githubAuth'),
                otp: false,
            },
            upload: {
                enabled: answers.features.includes('upload'),
                provider: 'local',
            },
            logging: {
                enabled: answers.features.includes('logging'),
                level: 'info',
            },
            email: {
                enabled: answers.features.includes('email'),
                provider: 'nodemailer',
            },
        };

        fs.writeFileSync(
            path.join(process.cwd(), 'features.json'),
            JSON.stringify(featuresConfig, null, 2)
        );
        console.log('‚úÖ Generated features.json');

        // 3. Create .env from example (simple copy for now)
        const envPath = path.join(process.cwd(), '.env');
        if (!fs.existsSync(envPath)) {
            // Create a basic .env
            const envContent = `
PORT=8000
NODE_ENV=development
MONGO_URI=mongodb://localhost:27017/${answers.projectName}
JWT_SECRET=super-secret-change-me
SESSION_SECRET=super-secret-session
# Add other keys as needed based on features
`;
            fs.writeFileSync(envPath, envContent.trim());
            console.log('‚úÖ Created .env file');
        }

        // 4. Run npm install
        if (answers.installDeps) {
            console.log('üì¶ Installing dependencies...');
            execSync('npm install', { stdio: 'inherit' });
            console.log('‚úÖ Dependencies installed');
        }

        console.log('\\nüéâ Setup Complete! Happy Coding! üéâ');
        console.log('Run "npm run dev" to start your server.');

    } catch (error) {
        console.error('‚ùå Setup failed:', error);
    }
};

runSetup();
